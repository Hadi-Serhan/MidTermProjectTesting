name: CI


on:
  push:
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-latest

    services:
      vaultwarden:
        image: vaultwarden/server:latest
        ports:
          - 3000:80
        env:
          SIGNUPS_ALLOWED: "true"
          WEBSOCKET_ENABLED: "true"
        options: >-
          --health-cmd "curl -fsS http://localhost:80/alive || exit 1"
          --health-interval=5s
          --health-retries=20
          --health-timeout=2s
          --health-start-period=5s

    env:
      VAULTWARDEN_URL: "http://localhost:3000"
      CLIENT_ID: ${{ secrets.VW_CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.VW_CLIENT_SECRET }}
      VW_BASE_URL: ${{ secrets.VW_BASE_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y curl xvfb

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Wait for Vaultwarden to be up
        run: |
          for i in {1..60}; do
            if curl -fsS "${VAULTWARDEN_URL}/alive" >/dev/null; then
              exit 0
            fi
            sleep 2
          done
          exit 1

      - name: Run health + version tests
        run: |
          python -m pytest -q tests/api -k "health or version" --maxfail=1

      - name: Run API auth tests against external instance
        if: ${{ env.CLIENT_ID != '' && env.CLIENT_SECRET != '' && env.VW_BASE_URL != '' }}
        env:
          VAULTWARDEN_URL: ${{ env.VW_BASE_URL }}
        run: |
          python -m pytest -q tests/api -k "not health and not version" --maxfail=1

      - name: Run UI tests headlessly
        run: |
          xvfb-run -a python -m pytest -q tests/ui --maxfail=1
